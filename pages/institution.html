---
layout: default
title: Institution
permalink: /institution/
---

<div class="institution-detail" id="institution-container">
  <div class="loading">Loading institution details...</div>
</div>

<script>
  // Get institution slug from URL query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get('slug');
  
  if (!slug) {
    document.getElementById('institution-container').innerHTML = '<div class="error">No institution specified</div>';
  } else {
    loadInstitution(slug);
  }
  
  async function loadInstitution(slug) {
    try {
      // Load data-loader helper if not already loaded
      if (typeof DataLoader === 'undefined') {
        await loadScript('{{ "/assets/data/data-loader.js" | relative_url }}');
      }
      // Ensure base URL respects Jekyll baseurl
      if (typeof DataLoader !== 'undefined') {
        DataLoader.baseUrl = '{{ site.baseurl }}/assets/data';
      }
      
      const institution = await DataLoader.loadInstitution(slug);
      
      if (!institution) {
        document.getElementById('institution-container').innerHTML = '<div class="error">Institution not found</div>';
        return;
      }
      
      // Load lectures to find lectures at this institution (as venue or organizer)
      // TODO: Could optimize this with an institution->lectures index
      const allLectures = await DataLoader.loadAllLectures();
      
      const asVenue = allLectures.filter(lecture => 
        lecture.venue && lecture.venue.id === institution.id
      );
      
      const asOrganizer = allLectures.filter(lecture => 
        lecture.organizer && lecture.organizer.id === institution.id
      );
      
      // Get all unique lectures (some may be both venue and organizer)
      const lectureIds = new Set();
      const allInstitutionLectures = [];
      
      asVenue.forEach(lecture => {
        if (!lectureIds.has(lecture.id)) {
          lectureIds.add(lecture.id);
          allInstitutionLectures.push({ ...lecture, role: 'venue' });
        }
      });
      
      asOrganizer.forEach(lecture => {
        if (!lectureIds.has(lecture.id)) {
          lectureIds.add(lecture.id);
          allInstitutionLectures.push({ ...lecture, role: 'organizer' });
        } else {
          // Update role if already added as venue
          const existing = allInstitutionLectures.find(l => l.id === lecture.id);
          if (existing) {
            existing.role = 'both';
          }
        }
      });
      
      renderInstitution(institution, allInstitutionLectures, asVenue.length, asOrganizer.length);
    } catch (error) {
      console.error('Error loading institution:', error);
      document.getElementById('institution-container').innerHTML = '<div class="error">Error loading institution</div>';
    }
  }
  
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  function renderInstitution(institution, lectures, venueCount, organizerCount) {
    const container = document.getElementById('institution-container');
    
    // Sort lectures by date (most recent first)
    lectures.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Get unique speakers
    const speakersMap = new Map();
    lectures.forEach(lecture => {
      if (lecture.speakers) {
        lecture.speakers.forEach(speaker => {
          if (!speakersMap.has(speaker.id)) {
            speakersMap.set(speaker.id, speaker);
          }
        });
      }
    });
    const uniqueSpeakers = Array.from(speakersMap.values());
    
    // Get unique topics
    const topicsMap = new Map();
    lectures.forEach(lecture => {
      if (lecture.topics) {
        lecture.topics.forEach(topic => {
          if (!topicsMap.has(topic.id)) {
            topicsMap.set(topic.id, topic);
          }
        });
      }
    });
    const uniqueTopics = Array.from(topicsMap.values());
    
    // Count lectures by supercategory
    const categoryCount = {};
    lectures.forEach(lecture => {
      if (lecture.supercategory) {
        categoryCount[lecture.supercategory] = (categoryCount[lecture.supercategory] || 0) + 1;
      }
    });
    
    // Build address
    const addressParts = [];
    if (institution.address1) addressParts.push(institution.address1);
    if (institution.address2) addressParts.push(institution.address2);
    if (institution.city) addressParts.push(institution.city);
    if (institution.county) addressParts.push(institution.county);
    if (institution.postcode) addressParts.push(institution.postcode);
    if (institution.country && institution.country !== 'United Kingdom') addressParts.push(institution.country);
    
    container.innerHTML = `
      <div class="container">
        <div class="institution-header">
          <h1 class="institution-name">${institution.name}</h1>
          ${addressParts.length > 0 ? `
            <p class="institution-address">${addressParts.join(', ')}</p>
          ` : ''}
          ${institution.telephone ? `<p class="institution-phone">Tel: ${institution.telephone}</p>` : ''}
          ${institution.url ? `<p class="institution-url"><a href="${institution.url}" target="_blank" rel="noopener">${institution.url}</a></p>` : ''}
        </div>
        
        <div class="institution-stats">
          <div class="stat-card">
            <div class="stat-number">${lectures.length}</div>
            <div class="stat-label">Total Lectures</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${venueCount}</div>
            <div class="stat-label">As Venue</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${organizerCount}</div>
            <div class="stat-label">As Organizer</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${uniqueSpeakers.length}</div>
            <div class="stat-label">Speakers</div>
          </div>
        </div>
        
        ${Object.keys(categoryCount).length > 0 ? `
          <div class="institution-categories">
            <h3>Lectures by Category</h3>
            <div class="category-list">
              ${Object.entries(categoryCount)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, count]) => `
                  <span class="category-badge" data-category="${cat}">
                    ${cat} (${count})
                  </span>
                `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${uniqueTopics.length > 0 ? `
          <div class="institution-topics">
            <h3>Topics Covered</h3>
            <div class="topic-list">
              ${uniqueTopics.slice(0, 20).map(topic => `
                <a href="{{ '/topic/' | relative_url }}?id=${topic.id}" class="topic-tag">${topic.name}</a>
              `).join('')}
              ${uniqueTopics.length > 20 ? `<span class="more-topics">+${uniqueTopics.length - 20} more</span>` : ''}
            </div>
          </div>
        ` : ''}
        
        ${uniqueSpeakers.length > 0 ? `
          <div class="institution-speakers">
            <h3>Featured Speakers (${uniqueSpeakers.length})</h3>
            <div class="speakers-list">
              ${uniqueSpeakers.slice(0, 20).map(speaker => `
                <a href="{{ '/speaker/' | relative_url }}?slug=${speaker.slug}" class="speaker-link">${speaker.name}</a>
              `).join('')}
              ${uniqueSpeakers.length > 20 ? `<span class="more-speakers">+${uniqueSpeakers.length - 20} more</span>` : ''}
            </div>
          </div>
        ` : ''}
        
        <div class="institution-lectures">
          <h2>Lectures (${lectures.length})</h2>
          <div class="lectures-list">
            ${lectures.map(lecture => {
              const dateStr = lecture.date ? new Date(lecture.date).toLocaleDateString('en-GB', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              }) : 'Date TBA';
              
              const roleLabel = lecture.role === 'both' ? 'Venue & Organizer' : 
                               lecture.role === 'venue' ? 'Venue' : 'Organizer';
              
              return `
                <div class="lecture-item">
                  <div class="lecture-item-header">
                    <h3 class="lecture-item-title">
                      <a href="{{ '/lecture/' | relative_url }}?slug=${lecture.slug}">${lecture.title}</a>
                    </h3>
                    <span class="lecture-item-date">${dateStr}</span>
                  </div>
                  ${lecture.synopsis ? `<p class="lecture-item-synopsis">${lecture.synopsis}</p>` : ''}
                  <div class="lecture-item-meta">
                    <span class="role-badge">${roleLabel}</span>
                    ${lecture.speakers && lecture.speakers.length > 0 ? `
                      <span class="speakers-list-inline">
                        ${lecture.speakers.map(s => s.name).join(', ')}
                      </span>
                    ` : ''}
                    ${lecture.supercategory ? `<span class="category-badge small" data-category="${lecture.supercategory}">${lecture.supercategory}</span>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
    
    // Update page title
    document.title = `${institution.name} - The Lecture List`;
  }
</script>

<style>
  .institution-detail {
    padding: 2rem 0;
  }
  
  .institution-header {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .institution-name {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  
  .institution-address,
  .institution-phone {
    color: #666;
    margin-bottom: 0.25rem;
  }
  
  .institution-url a {
    color: #007bff;
    text-decoration: none;
  }
  
  .institution-url a:hover {
    text-decoration: underline;
  }
  
  .institution-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 0.5rem;
  }
  
  .stat-label {
    color: #666;
    font-size: 0.875rem;
  }
  
  .institution-categories,
  .institution-topics,
  .institution-speakers {
    margin-bottom: 2rem;
  }
  
  .institution-categories h3,
  .institution-topics h3,
  .institution-speakers h3 {
    margin-bottom: 1rem;
  }
  
  .category-list,
  .topic-list,
  .speakers-list {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .category-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #007bff;
    color: white;
    border-radius: 4px;
    font-size: 0.875rem;
    text-transform: capitalize;
  }
  
  .category-badge.small {
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
  }
  
  .topic-tag,
  .speaker-link {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #f0f0f0;
    color: #333;
    border-radius: 4px;
    font-size: 0.875rem;
    text-decoration: none;
  }
  
  .topic-tag:hover,
  .speaker-link:hover {
    background: #e0e0e0;
  }
  
  .more-topics,
  .more-speakers {
    color: #666;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
  }
  
  .institution-lectures h2 {
    margin-bottom: 1.5rem;
  }
  
  .lectures-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .lecture-item {
    padding: 1.5rem;
    background: #f9f9f9;
    border-radius: 8px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .lecture-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .lecture-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .lecture-item-title {
    margin: 0;
    font-size: 1.25rem;
    flex: 1;
  }
  
  .lecture-item-title a {
    color: #333;
    text-decoration: none;
  }
  
  .lecture-item-title a:hover {
    color: #007bff;
  }
  
  .lecture-item-date {
    color: #666;
    font-size: 0.875rem;
    white-space: nowrap;
  }
  
  .lecture-item-synopsis {
    margin: 0.5rem 0;
    color: #666;
    line-height: 1.5;
  }
  
  .lecture-item-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }
  
  .role-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #28a745;
    color: white;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  
  .speakers-list-inline {
    color: #666;
    font-size: 0.875rem;
  }
  
  .loading,
  .error {
    padding: 2rem;
    text-align: center;
    color: #666;
  }
  
  .error {
    color: #dc3545;
  }
  
  @media (max-width: 768px) {
    .lecture-item-header {
      flex-direction: column;
    }
    
    .lecture-item-date {
      align-self: flex-start;
    }
  }
</style>
